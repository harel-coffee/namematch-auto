

<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>namematch.model_evaluation_functions &mdash; namematch 0.0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

</head>

<body>
    <header>
        <div class="container">
            <a class="site-nav-toggle hidden-lg-up"><i class="icon-menu"></i></a>
            <a class="site-title" href="../../index.html">
                namematch
            </a>
        </div>
    </header>


<div class="breadcrumbs-outer hidden-xs-down">
    <div class="container">
        















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="breadcrumbs">
    
      <li><a href="../../index.html">Docs</a></li>
        
          <li><a href="../index.html">Module code</a></li>
        
      <li>namematch.model_evaluation_functions</li>
    
    
      <li class="breadcrumbs-aside">
        
      </li>
    
  </ul>
</div>
    </div>
</div>
    <div class="main-outer">
        <div class="container">
            <div class="row">
                <div class="col-12 col-lg-3 site-nav">
                    
<div role="search">
    <form class="search" action="../../search.html" method="get">
        <div class="icon-input">
            <input type="text" name="q" placeholder="Search" />
            <span class="icon-search"></span>
        </div>
        <input type="submit" value="Go" class="d-hidden" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div>
                    <div class="site-nav-tree">
                        
                            
                            
                                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About Name Match</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../about.html#what-is-name-match-doing">What is Name Match doing?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about.html#inputs-and-outputs">Inputs and outputs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../match_setup.html">Setting Up a Match</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../match_setup.html#preparing-the-data-for-name-match">Preparing the data for Name Match</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../match_setup.html#creating-the-configuration-file">Creating the configuration file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../match_setup.html#creating-user-defined-clustering-functions">Creating user defined clustering functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../match_setup.html#running-the-code">Running the code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../match_setup.html#special-cases">Special cases</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../understanding_results.html">Understanding Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithm.html">Algorithm Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../algorithm.html#why-is-name-match-necessary">Why is Name Match necessary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../algorithm.html#how-it-works">How it works</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../algorithm.html#things-to-consider">Things to consider</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-namematch.process_config"><code class="xref py py-mod docutils literal notranslate"><span class="pre">namematch.process_config</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-namematch.process_input_data"><code class="xref py py-mod docutils literal notranslate"><span class="pre">namematch.process_input_data</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-namematch.generate_must_links"><code class="xref py py-mod docutils literal notranslate"><span class="pre">namematch.generate_must_links</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-namematch.block"><code class="xref py py-mod docutils literal notranslate"><span class="pre">namematch.block</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-namematch.generate_data_rows"><code class="xref py py-mod docutils literal notranslate"><span class="pre">namematch.generate_data_rows</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-namematch.fit_model"><code class="xref py py-mod docutils literal notranslate"><span class="pre">namematch.fit_model</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-namematch.predict"><code class="xref py py-mod docutils literal notranslate"><span class="pre">namematch.predict</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-namematch.cluster"><code class="xref py py-mod docutils literal notranslate"><span class="pre">namematch.cluster</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api.html#module-namematch.generate_output"><code class="xref py py-mod docutils literal notranslate"><span class="pre">namematch.generate_output</span></code></a></li>
</ul>
</li>
</ul>

                            
                        
                    </div>
                </div>
                <div class="col-12 col-lg-9">
                    <div class="document">
                        
                            
  <h1>Source code for namematch.model_evaluation_functions</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">namematch.utils.utils</span> <span class="kn">import</span> <span class="n">log_runtime_and_memory</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">profile</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">line_profiler</span> <span class="kn">import</span> <span class="n">LineProfiler</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">LineProfiler</span><span class="p">()</span>


<div class="viewcode-block" id="get_confusion_matrix"><a class="viewcode-back" href="../../namematch.html#namematch.model_evaluation_functions.get_confusion_matrix">[docs]</a><span class="k">def</span> <span class="nf">get_confusion_matrix</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Compute confusion matrix. </span>

<span class="sd">    Args: </span>
<span class="sd">        preds (pd.Series): predicted probabilty of match (float), for a set of labeled record pairs</span>
<span class="sd">        labels (pd.Series): flag, 1 if the record pairs are actually a match 0 otherwise</span>
<span class="sd">        threshold (float): probability threshold that optimizes fscore</span>

<span class="sd">    Returns: </span>
<span class="sd">        float: confusion matrix</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">preds</span> <span class="o">&gt;=</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># true positive</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># false positve</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># false negative</span>
    <span class="n">tn</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># true negatives</span>
    <span class="k">return</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tn</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_precision"><a class="viewcode-back" href="../../namematch.html#namematch.model_evaluation_functions.get_precision">[docs]</a><span class="k">def</span> <span class="nf">get_precision</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Compute precision. </span>

<span class="sd">    Args: </span>
<span class="sd">        preds (pd.Series): predicted probabilty of match (float), for a set of labeled record pairs</span>
<span class="sd">        labels (pd.Series): flag, 1 if the record pairs are actually a match 0 otherwise</span>
<span class="sd">        threshold (float): probability threshold that optimizes fscore</span>

<span class="sd">    Returns: </span>
<span class="sd">        float: precision</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tn</span> <span class="o">=</span> <span class="n">get_confusion_matrix</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_recall"><a class="viewcode-back" href="../../namematch.html#namematch.model_evaluation_functions.get_recall">[docs]</a><span class="k">def</span> <span class="nf">get_recall</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Compute recall. </span>

<span class="sd">    Args: </span>
<span class="sd">        preds (pd.Series): predicted probabilty of match (float), for a set of labeled record pairs</span>
<span class="sd">        labels (pd.Series): flag, 1 if the record pairs are actually a match 0 otherwise</span>
<span class="sd">        threshold (float): probability threshold that optimizes fscore</span>

<span class="sd">    Returns: </span>
<span class="sd">        float: recall</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tn</span> <span class="o">=</span> <span class="n">get_confusion_matrix</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_fscore"><a class="viewcode-back" href="../../namematch.html#namematch.model_evaluation_functions.get_fscore">[docs]</a><span class="k">def</span> <span class="nf">get_fscore</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Compute fscore. </span>

<span class="sd">    Args: </span>
<span class="sd">        preds (pd.Series): predicted probabilty of match (float), for a set of labeled record pairs</span>
<span class="sd">        labels (pd.Series): flag, 1 if the record pairs are actually a match 0 otherwise</span>
<span class="sd">        threshold (float): probability threshold that optimizes fscore</span>
<span class="sd">        beta (float): ratio of recall weighting to precision weighting (e.g. 0.5 weights precision double)</span>

<span class="sd">    Returns: </span>
<span class="sd">        float: fscore</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">precision</span> <span class="o">=</span> <span class="n">get_precision</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">get_recall</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>
    <span class="n">fscore</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">precision</span> <span class="o">+</span> <span class="n">recall</span><span class="p">):</span>
        <span class="n">fscore</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">((</span><span class="n">precision</span> <span class="o">*</span> <span class="n">recall</span><span class="p">)</span> <span class="o">/</span> <span class="p">(((</span><span class="n">beta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">precision</span><span class="p">)</span> <span class="o">+</span> <span class="n">recall</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fscore</span></div>


<div class="viewcode-block" id="get_accuracy"><a class="viewcode-back" href="../../namematch.html#namematch.model_evaluation_functions.get_accuracy">[docs]</a><span class="k">def</span> <span class="nf">get_accuracy</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Compute accuracy. </span>

<span class="sd">    Args: </span>
<span class="sd">        preds (pd.Series): predicted probabilty of match (float), for a set of labeled record pairs</span>
<span class="sd">        labels (pd.Series): flag, 1 if the record pairs are actually a match 0 otherwise</span>
<span class="sd">        threshold (float): probability threshold that optimizes fscore</span>

<span class="sd">    Returns: </span>
<span class="sd">        float: accuracy</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tn</span> <span class="o">=</span> <span class="n">get_confusion_matrix</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">tn</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">tn</span> <span class="o">+</span> <span class="n">fn</span> <span class="o">+</span> <span class="n">fp</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_fpr"><a class="viewcode-back" href="../../namematch.html#namematch.model_evaluation_functions.get_fpr">[docs]</a><span class="k">def</span> <span class="nf">get_fpr</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Compute false postive rate. </span>

<span class="sd">    Args: </span>
<span class="sd">        preds (pd.Series): predicted probabilty of match (float), for a set of labeled record pairs</span>
<span class="sd">        labels (pd.Series): flag, 1 if the record pairs are actually a match 0 otherwise</span>
<span class="sd">        threshold (float): probability threshold that optimizes fscore</span>

<span class="sd">    Returns: </span>
<span class="sd">        float: false positive rate</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tn</span> <span class="o">=</span> <span class="n">get_confusion_matrix</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">tn</span><span class="p">))</span></div>


<div class="viewcode-block" id="pairwise_metrics"><a class="viewcode-back" href="../../namematch.html#namematch.model_evaluation_functions.pairwise_metrics">[docs]</a><span class="k">def</span> <span class="nf">pairwise_metrics</span><span class="p">(</span><span class="n">labeled_preds</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">phat_col</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">fscore_beta</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generate evaluation metrics that are standard for classification problems (e.g. precision, auc). </span>

<span class="sd">    Args: </span>
<span class="sd">        labeled_preds (pd.DataFrame): df with labeled test phats and columns needed for evaluation (limited to a universe)</span>
<span class="sd">        threshold (float): probability threshold that optimizes fscore</span>
<span class="sd">        phat_col: phat column for evaluation</span>
<span class="sd">        outcome: outcome to evaluate</span>
<span class="sd">        fscore_beta: ratio of recall weighting to precision weighting (e.g. 0.5 weights precision double)</span>
<span class="sd">    </span>
<span class="sd">    Return: </span>
<span class="sd">        list of floats: base_rate, precision, recall, fpr, fnr, auc, accuracy, fscore</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">labeled_preds</span> <span class="o">=</span> <span class="n">labeled_preds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">preds</span> <span class="o">=</span> <span class="n">labeled_preds</span><span class="p">[</span><span class="n">phat_col</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">labeled_preds</span><span class="p">[</span><span class="n">outcome</span><span class="p">]</span>
    <span class="n">base_rate</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">get_precision</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">get_recall</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">fpr</span> <span class="o">=</span> <span class="n">get_fpr</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">fnr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">recall</span>
    <span class="n">fscore</span> <span class="o">=</span> <span class="n">get_fscore</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">fscore_beta</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">get_accuracy</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>

    <span class="n">fpr_auc</span><span class="p">,</span> <span class="n">tpr_auc</span><span class="p">,</span> <span class="n">thresholds_auc</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">roc_curve</span><span class="p">(</span><span class="n">labeled_preds</span><span class="p">[</span><span class="n">outcome</span><span class="p">],</span> <span class="n">labeled_preds</span><span class="p">[</span><span class="n">phat_col</span><span class="p">])</span>
    <span class="n">auc</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">auc</span><span class="p">(</span><span class="n">fpr_auc</span><span class="p">,</span> <span class="n">tpr_auc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">base_rate</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">fpr</span><span class="p">,</span> <span class="n">fnr</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">fscore</span></div>


<span class="nd">@log_runtime_and_memory</span>
<span class="k">def</span> <span class="nf">find_best_threshold</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Find the threshold that optimizes fscore.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): predicted and actual values</span>
<span class="sd">            =====================   =======================================================</span>
<span class="sd">            label                   whether the pair is a match or not</span>
<span class="sd">            &lt;phat_col&gt;              predicted probability of match</span>
<span class="sd">            =====================   =======================================================</span>
<span class="sd">        beta (float): ratio of recall weighting to precision weighting (e.g. 0.5 weights precision double)</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: probability threshold that optimizes fscore</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finding optimal threshold.&#39;</span><span class="p">)</span>

    <span class="n">best_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">best_fscore</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fscore</span> <span class="o">=</span> <span class="n">get_fscore</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">outcome</span><span class="p">,</span> <span class="n">t</span><span class="o">/</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">fscore</span> <span class="o">&gt;</span> <span class="n">best_fscore</span><span class="p">:</span>
            <span class="n">best_fscore</span> <span class="o">=</span> <span class="n">fscore</span>
            <span class="n">best_t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">/</span> <span class="mf">100.0</span>

    <span class="k">if</span> <span class="n">best_t</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Problem calculating optimal threshold.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>

    <span class="k">return</span> <span class="n">best_t</span>


<span class="nd">@log_runtime_and_memory</span>
<span class="k">def</span> <span class="nf">evaluate_predictions</span><span class="p">(</span><span class="n">phat_df</span><span class="p">,</span> <span class="n">phat_col</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span>
        <span class="n">default_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">missingness_model_threshold_boost</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">optimize_threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fscore_beta</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">logger_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculates metrics such as precision, recall, fscore, etc. for the pairwise record</span>
<span class="sd">    match predictions. Also, get the threshold that maximizes f score.</span>

<span class="sd">    Args:</span>
<span class="sd">        phat_df (pd.DataFrame): df with labeled test phats and columns needed for evaluation</span>
<span class="sd">        phat_col (str): phat column for evaluation</span>
<span class="sd">        outcome (str): outcome to evaluate</span>
<span class="sd">        default_threshold (float): threshold for match/non-match (use if don&#39;t find optimal)</span>
<span class="sd">        missingness_model_threshold_boost (float): value to add to default threshold if missingess model</span>
<span class="sd">        optimize_threshold (bool): should we find the threshold that optimizes f1</span>
<span class="sd">        fscore_beta (float): ratio of recall weighting to precision weighting (e.g. 0.5 weights precision double)</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: probability threshold that optimizes fscore</span>
<span class="sd">        dict: keys are universe str, values are dicts with perf metrics</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">logger_id</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;namematch_</span><span class="si">{</span><span class="n">logger_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>

    <span class="n">phat_df</span> <span class="o">=</span> <span class="n">phat_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># hacky for now</span>
    <span class="k">if</span> <span class="s1">&#39;no_&#39;</span> <span class="ow">in</span> <span class="n">phat_col</span> <span class="ow">and</span> <span class="s1">&#39;basic&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phat_col</span><span class="p">:</span>
        <span class="n">default_threshold</span> <span class="o">=</span> <span class="n">default_threshold</span> <span class="o">+</span> <span class="n">missingness_model_threshold_boost</span>

    <span class="k">if</span> <span class="n">outcome</span> <span class="o">!=</span> <span class="s1">&#39;match_train_eligible&#39;</span><span class="p">:</span>
        <span class="n">phat_df</span> <span class="o">=</span> <span class="n">phat_df</span><span class="p">[</span><span class="n">phat_df</span><span class="o">.</span><span class="n">match_train_eligible</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phat_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to measure performance (no labeled testing data available).&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default_threshold</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of labeled test rows evaluated: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">phat_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">optimize_threshold</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">phat_df</span><span class="p">[[</span><span class="n">phat_col</span><span class="p">,</span> <span class="n">outcome</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span> <span class="s1">&#39;outcome&#39;</span><span class="p">]</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">find_best_threshold</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">fscore_beta</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">default_threshold</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find optimal threshold, using </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">default_threshold</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Threshold: </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">all_model_stats</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">universe</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all pairs&#39;</span><span class="p">,</span> <span class="s1">&#39;non exactmatch pairs&#39;</span><span class="p">,</span> <span class="s1">&#39;exactmatch pairs&#39;</span><span class="p">]:</span>

        <span class="n">model_stats</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">phat_univ_df</span> <span class="o">=</span> <span class="n">phat_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">universe</span> <span class="o">==</span> <span class="s1">&#39;non exactmatch pairs&#39;</span><span class="p">:</span>
            <span class="n">phat_univ_df</span> <span class="o">=</span> <span class="n">phat_df</span><span class="p">[</span><span class="n">phat_df</span><span class="o">.</span><span class="n">exactmatch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">universe</span> <span class="o">==</span> <span class="s1">&#39;exactmatch pairs&#39;</span><span class="p">:</span>
            <span class="n">phat_univ_df</span> <span class="o">=</span> <span class="n">phat_df</span><span class="p">[</span><span class="n">phat_df</span><span class="o">.</span><span class="n">exactmatch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># log phat distributions</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">one_phats</span> <span class="o">=</span> <span class="n">phat_univ_df</span><span class="p">[</span><span class="n">phat_univ_df</span><span class="p">[</span><span class="n">outcome</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][</span><span class="n">phat_col</span><span class="p">]</span>
            <span class="n">one_phat_dist</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">one_phats</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">)),</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Phat distribution of actual 1s (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s1">): </span><span class="se">\n</span><span class="si">{</span><span class="n">one_phat_dist</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">model_stats</span><span class="p">[</span><span class="s1">&#39;phat_distribution_1s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">one_phat_dist</span><span class="p">)</span>

            <span class="n">zero_phats</span> <span class="o">=</span> <span class="n">phat_univ_df</span><span class="p">[</span><span class="n">phat_univ_df</span><span class="p">[</span><span class="n">outcome</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][</span><span class="n">phat_col</span><span class="p">]</span>
            <span class="n">zero_phat_dist</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">zero_phats</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">)),</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Phat distribution of actual 0s (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s1">): </span><span class="se">\n</span><span class="si">{</span><span class="n">zero_phat_dist</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">model_stats</span><span class="p">[</span><span class="s1">&#39;phat_distribution_0s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">zero_phat_dist</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issue calculating phat distributions (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">baserate</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">fpr</span><span class="p">,</span> <span class="n">fnr</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">,</span> <span class="n">fscore</span> <span class="o">=</span> <span class="n">pairwise_metrics</span><span class="p">(</span>
                <span class="n">phat_univ_df</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">phat_col</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">fscore_beta</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base rate (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">baserate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model_stats</span><span class="p">[</span><span class="s1">&#39;baserate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">baserate</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">precision</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model_stats</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">recall</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model_stats</span><span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;False positive rate (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">fpr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model_stats</span><span class="p">[</span><span class="s1">&#39;fp_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">fpr</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;False negative rate (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">fnr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model_stats</span><span class="p">[</span><span class="s1">&#39;fn_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">fnr</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">auc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model_stats</span><span class="p">[</span><span class="s1">&#39;auc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F-score (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">fscore</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model_stats</span><span class="p">[</span><span class="s1">&#39;fscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">fscore</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issue with given threshold -- not all areas of confusion &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;matrix present (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">universe</span> <span class="o">==</span> <span class="s2">&quot;all pairs&quot;</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">up_recall</span> <span class="o">=</span> <span class="n">get_recall</span><span class="p">(</span><span class="n">up_phat_df</span><span class="p">[</span><span class="n">phat_col</span><span class="p">],</span> <span class="n">up_phat_df</span><span class="p">[</span><span class="n">outcome</span><span class="p">],</span> <span class="n">threshold</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uncovered pair recall (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">up_recall</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">model_stats</span><span class="p">[</span><span class="s1">&#39;up_recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">up_recall</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issue generating uncovered pair recall (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># manually set preds to 0 if uncovered</span>
                <span class="n">phat_univ_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">phat_univ_df</span><span class="o">.</span><span class="n">covered_pair</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phat_col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">total_recall</span> <span class="o">=</span> <span class="n">get_recall</span><span class="p">(</span><span class="n">phat_univ_df</span><span class="p">[</span><span class="n">phat_col</span><span class="p">],</span> <span class="n">phat_univ_df</span><span class="p">[</span><span class="n">outcome</span><span class="p">],</span> <span class="n">threshold</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total recall (</span><span class="si">{</span><span class="n">universe</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">total_recall</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">model_stats</span><span class="p">[</span><span class="s1">&#39;total_recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">total_recall</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Issue computing total recall (</span><span class="si">%s</span><span class="s2">).&quot;</span><span class="p">)</span>

        <span class="n">all_model_stats</span><span class="p">[</span><span class="n">universe</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_stats</span>

    <span class="k">return</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">all_model_stats</span>


<div class="viewcode-block" id="evaluate_models"><a class="viewcode-back" href="../../namematch.html#namematch.model_evaluation_functions.evaluate_models">[docs]</a><span class="k">def</span> <span class="nf">evaluate_models</span><span class="p">(</span><span class="n">phats_df</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">default_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">missingness_model_threshold_boost</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">optimize_threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fscore_beta</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">logger_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Wrapper for evaluating different models (e.g. basic and no-dob) on different universes. </span>

<span class="sd">    Args:</span>
<span class="sd">        phat_df (pd.DataFrame): df with labeled test phats and columns needed for evaluation</span>
<span class="sd">        outcome (str): outcome to evaluate</span>
<span class="sd">        model_type (str): either &quot;selection&quot; or &quot;match&quot;</span>
<span class="sd">        default_threshold (float): threshold for match/non-match (use if don&#39;t find optimal)</span>
<span class="sd">        missingness_model_threshold_boost (float): value to add to default threshold if missingess model (use if don&#39;t find optimal)</span>
<span class="sd">        optimize_threshold (bool): should we find the threshold that optimizes fscore</span>
<span class="sd">        fscore_beta (float): ratio of recall weighting to precision weighting (e.g. 0.5 weights precision double)</span>

<span class="sd">    Return: </span>
<span class="sd">        dict: maps model name (e.g. basic, no-dob) to thresholds (no return type)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">logger_id</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;namematch_</span><span class="si">{</span><span class="n">logger_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>

    <span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">_phat&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">phats_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                   <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">_phat&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;selection&#39;</span><span class="p">:</span>
        <span class="n">optimize_threshold</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">thresholds</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">model_type_model_stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">model_names</span><span class="p">:</span>

        <span class="n">phats_to_eval_df</span> <span class="o">=</span> <span class="n">phats_df</span><span class="p">[</span><span class="n">phats_df</span><span class="o">.</span><span class="n">model_to_use</span> <span class="o">==</span> <span class="n">model_name</span><span class="p">]</span>
        <span class="c1"># NOTE: will cause problems if this universe isn&#39;t represented in the labeled data;</span>
        <span class="c1">#       use basic poplation as a backup</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phats_to_eval_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">phats_to_eval_df</span> <span class="o">=</span> <span class="n">phats_df</span><span class="p">[</span><span class="n">phats_df</span><span class="o">.</span><span class="n">model_to_use</span> <span class="o">==</span> <span class="s1">&#39;basic&#39;</span><span class="p">]</span>

        <span class="n">phat_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">_phat&#39;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;----- EVALUATING </span><span class="si">{</span><span class="n">model_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1"> MODEL -----&#39;</span><span class="p">)</span>
        <span class="n">thresholds</span><span class="p">[</span><span class="n">model_name</span><span class="p">],</span> \
        <span class="n">model_type_model_stats</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluate_predictions</span><span class="p">(</span>
                <span class="n">phats_to_eval_df</span><span class="p">,</span> <span class="n">phat_col</span><span class="p">,</span> <span class="n">outcome</span><span class="p">,</span>
                <span class="n">default_threshold</span><span class="p">,</span> <span class="n">missingness_model_threshold_boost</span><span class="p">,</span> <span class="n">optimize_threshold</span><span class="p">,</span> <span class="n">fscore_beta</span><span class="p">,</span> <span class="n">logger_id</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">stat_dict</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;model_stats__</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">model_type_model_stats</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;match&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">stat_dict</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;model_thresholds__</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">thresholds</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;match&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">thresholds</span></div>
</pre></div>

                        
                    </div>
                </div>
            </div>
        </div>
    </div>    


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  
    <div class="footer" role="contentinfo">
        <div class="container">
            &#169; Copyright 2021, Melissa McNeill, Eddie Lin, Zubin Jelveh.
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.1.1.
        </div>
    </div>  

</body>
</html>